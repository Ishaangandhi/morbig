#!/bin/sh

readonly PROGDIR=$(dirname "$0")
readonly OLDDIR=$PWD
cd "$PROGDIR"

okpat=*.sjson
kopat=*.morbigerror

# cleanup
find . \( -name "$okpat" -o -name "$kopat" \) -print -delete
[ "$1" = 'clean' ] && exit 0

# Find morbig; either in this directory, or in the $PATH
if [ -e ../bin/morbig ]
then
    morbig=../bin/morbig
elif which morbig 2>/dev/null
then
    printf 'Warning: Could not find morbig in this directory. Using the one in the PATH.\n'
    morbig=morbig
else
    printf 'Could not find morbig. Did you compile it?\n'
    exit 1
fi

# run
find . -name '*.sh' | xargs "$morbig" --continue-after-error --as simple

# Count bad successes and good failures
nrbadsuccess=$(find bad -name "$okpat" | wc -l)
nrgoodfailures=$(find good -name "$kopat" | wc -l)
nrunexpected=$(find good -name "*.expected" -exec $PROGDIR/checkexpectation {} \; | wc -l)

# Summarize
printf '=============================================================
Should fail:    OK: %3d  KO: %3d
Should succeed: OK: %3d  KO: %3d  OK but not as expected: %3d  
=============================================================\n' \
       "$(find bad -name "$kopat" | wc -l)" \
       "$nrbadsuccess" \
       "$(find good -name "$okpat" | wc -l)" \
       "$nrgoodfailures" \
       "$nrunexpected"

# Report the exact problematic tests
if [ $nrgoodfailures -gt 0 ]
then
    printf '** Failing tests that should succeed:\n'
    find good -name "$kopat" \
	| sed "s|\(.*\).morbigerror|$PROGDIR/\1|"
fi
if [ $nrunexpected -gt 0 ]
then
    printf '** Succeded test with unexpected output:\n'
    find good -name "*.expected" -exec $PROGDIR/checkexpectation {} \; \
	| sed "s|\(.*\).morbigerror|$PROGDIR/\1|"
fi
if [ $nrbadsuccess -gt 0 ]
then
    printf '** Succeeding tests that should fail:\n'
    find bad -name "$okpat" \
	| sed "s|\(.*\).sjson|$PROGDIR/\1|"
fi
